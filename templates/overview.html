{% extends "base.html" %}
{% set active = "overview" %}
{% block title %}Overview · EnergyIQ{% endblock %}
{% block content %}
<div class="page-header">
  <div class="page-title">Energy <span class="accent">Overview</span></div>
  <div class="page-subtitle">Nationwide consumption summary · all states · all time</div>
</div>

<div class="stat-grid" id="statsGrid">
  <div style="color:var(--muted);font-size:.85rem;padding:.5rem">Loading stats…</div>
</div>

<div class="chart-card">
  <div class="cc-head">
    <span class="cc-title">Energy Consumption Over Time</span>
    <div style="display:flex;gap:.6rem;align-items:center">
      <select id="tsStateFilter" style="width:auto"><option value="All">All States</option></select>
      <span class="cc-badge" id="tsBadge">–</span>
    </div>
  </div>
  <div class="chart-wrap" style="height:270px"><canvas id="tsChart"></canvas></div>
</div>

<div class="grid-2">
  <div class="chart-card" style="margin-bottom:0">
    <div class="cc-head"><span class="cc-title">Monthly Average Usage</span><span class="cc-badge">Seasonal</span></div>
    <div class="chart-wrap" style="height:210px"><canvas id="monthlyChart"></canvas></div>
  </div>
  <div class="chart-card" style="margin-bottom:0">
    <div class="cc-head"><span class="cc-title">Weekday vs Weekend</span><span class="cc-badge">Behavioural</span></div>
    <div class="chart-wrap" style="height:210px"><canvas id="wwChart"></canvas></div>
  </div>
</div>
<div class="grid-2" style="margin-top:1.5rem">
  <div class="chart-card" style="margin-bottom:0">
    <div class="cc-head"><span class="cc-title">Usage Distribution</span><span class="cc-badge">Histogram</span></div>
    <div class="chart-wrap" style="height:210px"><canvas id="distChart"></canvas></div>
  </div>
  <div class="chart-card" style="margin-bottom:0">
    <div class="cc-head"><span class="cc-title">Feature Importance (RF)</span><span class="cc-badge">Top 10</span></div>
    <div class="chart-wrap" style="height:210px"><canvas id="fiChart"></canvas></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(async () => {
  const [ov, stateList, m, ww, dist, fi] = await Promise.all([
    fetch('/api/overview').then(r=>r.json()),
    fetch('/api/state_list').then(r=>r.json()),
    fetch('/api/monthly').then(r=>r.json()),
    fetch('/api/weekday_weekend').then(r=>r.json()),
    fetch('/api/distribution').then(r=>r.json()),
    fetch('/api/feature_importance').then(r=>r.json()),
  ]);

  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card"><div class="stat-label">Records</div><div class="stat-value">${ov.total_records.toLocaleString()}</div><div class="stat-unit">data points</div></div>
    <div class="stat-card"><div class="stat-label">States</div><div class="stat-value">${ov.num_states}</div><div class="stat-unit">regions</div></div>
    <div class="stat-card"><div class="stat-label">Date Range</div><div class="stat-value" style="font-size:.9rem;line-height:1.35;margin-top:.15rem">${ov.date_range}</div></div>
    <div class="stat-card"><div class="stat-label">Avg Usage</div><div class="stat-value" style="color:var(--a1)">${ov.avg_usage}</div><div class="stat-unit">kWh / record</div></div>
    <div class="stat-card"><div class="stat-label">Peak</div><div class="stat-value" style="color:var(--a2)">${ov.max_usage}</div><div class="stat-unit">max kWh</div></div>
    <div class="stat-card"><div class="stat-label">Total</div><div class="stat-value">${(ov.total_usage/1e6).toFixed(2)}M</div><div class="stat-unit">kWh aggregate</div></div>
  `;

  const tsf = document.getElementById('tsStateFilter');
  stateList.forEach(s => tsf.innerHTML += `<option value="${s}">${s}</option>`);
  tsf.addEventListener('change', () => loadTS(tsf.value));
  await loadTS('All');

  mkChart('monthlyChart','line',{
    labels:m.months,
    datasets:[{label:'Avg Usage',data:m.usage,borderColor:C.a1,backgroundColor:'rgba(0,229,255,.07)',tension:.4,fill:true,pointRadius:4,pointBackgroundColor:C.a1}]
  }, lineOpts());

  mkChart('wwChart','bar',{
    labels:ww.labels,
    datasets:[{label:'Avg Usage',data:ww.values,backgroundColor:[C.a3,C.a2],borderRadius:8,borderSkipped:false}]
  }, barOpts({plugins:{legend:{display:false}}}));

  mkChart('distChart','bar',{
    labels:dist.bins,
    datasets:[{label:'Count',data:dist.counts,backgroundColor:'rgba(0,229,255,.3)',borderColor:C.a1,borderWidth:1,borderRadius:2}]
  }, barOpts({plugins:{legend:{display:false}}}));

  mkChart('fiChart','bar',{
    labels:fi.features.slice(0,10),
    datasets:[{label:'Importance',data:fi.importance.slice(0,10),
      backgroundColor:fi.importance.slice(0,10).map((_,i)=>`hsla(${185+i*14},75%,58%,.75)`),
      borderRadius:4,borderSkipped:false}]
  }, barOpts({indexAxis:'y',plugins:{legend:{display:false}}}));
})();

async function loadTS(state) {
  const url = state==='All' ? '/api/timeseries' : `/api/timeseries?state=${encodeURIComponent(state)}`;
  const ts = await fetch(url).then(r=>r.json());
  document.getElementById('tsBadge').textContent = `${ts.dates.length} pts`;
  mkChart('tsChart','line',{
    labels:ts.dates,
    datasets:[{label:'Usage',data:ts.usage,borderColor:C.a1,backgroundColor:'rgba(0,229,255,.04)',tension:.3,fill:true,pointRadius:0,borderWidth:2}]
  }, lineOpts({scales:{x:{grid:{color:C.border},ticks:{color:C.muted,maxTicksLimit:10}},y:{grid:{color:C.border},ticks:{color:C.muted}}}}));
}
</script>
{% endblock %}