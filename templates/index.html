{% extends "base.html" %}
{% set active = "overview" %}
{% block title %}Overview · EnergyIQ{% endblock %}
{% block content %}
<div class="page-header">
  <div class="page-title">Energy <span class="accent">Overview</span></div>
  <div class="page-subtitle">Nationwide consumption summary · all states · all time</div>
</div>

<div class="stat-grid" id="statsGrid">
  <div style="color:var(--muted);font-size:.85rem;padding:.5rem">Loading stats…</div>
</div>

<div class="chart-card">
  <div class="cc-head">
    <span class="cc-title">Temperature vs. Energy Usage</span>
    <span class="cc-badge">Scatter</span>
  </div>
  <div class="chart-wrap" style="height:270px"><canvas id="tempUsageChart"></canvas></div>
</div>

<div class="grid-2">
  <div class="chart-card" style="margin-bottom:0">
    <div class="cc-head">
      <span class="cc-title">Monthly Average Usage</span>
      <div style="display:flex;gap:.6rem;align-items:center">
        <select id="monthlyStateFilter">
          <option value="Overall">Overall</option>
        </select>
        <span class="cc-badge">Seasonal</span>
      </div>
    </div>
    <div class="chart-wrap" style="height:210px"><canvas id="monthlyChart"></canvas></div>
  </div>
  <div class="chart-card" style="margin-bottom:0">
    <div class="cc-head"><span class="cc-title">Weekday vs Weekend</span><span class="cc-badge">Behavioural</span></div>
    <div class="chart-wrap" style="height:210px"><canvas id="wwChart"></canvas></div>
  </div>
</div>
<div class="grid-2" style="margin-top:1.5rem">
  <div class="chart-card" style="margin-bottom:0">
    <div class="cc-head">
      <span class="cc-title">Usage Distribution</span>
      <div style="display:flex;gap:.6rem;align-items:center">
        <select id="distStateFilter">
          <option value="Overall">Overall</option>
        </select>
        <span class="cc-badge">Histogram</span>
      </div>
    </div>
    <div class="chart-wrap" style="height:210px"><canvas id="distChart"></canvas></div>
  </div>
  <div class="chart-card" style="margin-bottom:0">
    <div class="cc-head"><span class="cc-title">Feature Importance (RF)</span><span class="cc-badge">Top 10</span></div>
    <div class="chart-wrap" style="height:210px"><canvas id="fiChart"></canvas></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (async () => {
    const [ov, stateList, tempData] = await Promise.all([
      fetch('/api/overview').then(r => r.json()),
      fetch('/api/state_list').then(r => r.json()),
      fetch('/api/temp_vs_usage').then(r => r.json())
    ]);

    document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card"><div class="stat-label">Records</div><div class="stat-value">${ov.total_records.toLocaleString()}</div><div class="stat-unit">data points</div></div>
    <div class="stat-card"><div class="stat-label">States</div><div class="stat-value">${ov.num_states}</div><div class="stat-unit">regions</div></div>
    <div class="stat-card"><div class="stat-label">Date Range</div><div class="stat-value" style="font-size:.9rem;line-height:1.35;margin-top:.15rem">${ov.date_range}</div></div>
    <div class="stat-card"><div class="stat-label">Avg Usage</div><div class="stat-value" style="color:var(--a1)">${ov.avg_usage}</div><div class="stat-unit">kWh / record</div></div>
    <div class="stat-card"><div class="stat-label">Peak</div><div class="stat-value" style="color:var(--a2)">${ov.max_usage}</div><div class="stat-unit">max kWh</div></div>
    <div class="stat-card"><div class="stat-label">Total</div><div class="stat-value">${(ov.total_usage / 1e6).toFixed(2)}M</div><div class="stat-unit">kWh aggregate</div></div>
  `;

    mkChart('tempUsageChart', 'scatter', {
      datasets: [{
        label: 'Temp vs Usage',
        data: tempData,
        backgroundColor: 'rgba(0,229,255,0.6)',
        borderColor: C.a1,
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    }, {
      plugins: { legend: { display: false } },
      scales: {
        x: { title: { display: true, text: 'Temperature (°C)', color: C.muted }, grid: { display: false }, ticks: { color: C.muted } },
        y: { title: { display: true, text: 'Average Usage (kWh)', color: C.muted }, grid: { color: C.border }, ticks: { color: C.muted } }
      }
    });

    const mSF = document.getElementById('monthlyStateFilter');
    const dSF = document.getElementById('distStateFilter');
    stateList.forEach(s => {
      mSF.innerHTML += `<option value="${s}">${s}</option>`;
      dSF.innerHTML += `<option value="${s}">${s}</option>`;
    });
    mSF.addEventListener('change', () => loadMonthly(mSF.value));
    dSF.addEventListener('change', () => loadDist(dSF.value));
    await Promise.all([loadMonthly('Overall'), loadDist('Overall')]);

    const [ww, fi] = await Promise.all([
      fetch('/api/weekday_weekend').then(r => r.json()),
      fetch('/api/feature_importance').then(r => r.json())
    ]);

    mkChart('wwChart', 'bar', {
      labels: ww.labels,
      datasets: [{ label: 'Avg Usage', data: ww.values, backgroundColor: [C.a3, C.a2], borderRadius: 8, borderSkipped: false }]
    }, barOpts({ plugins: { legend: { display: false } } }));

    mkChart('fiChart', 'bar', {
      labels: fi.features.slice(0, 10),
      datasets: [{
        label: 'Importance', data: fi.importance.slice(0, 10),
        backgroundColor: fi.importance.slice(0, 10).map((_, i) => `hsla(${185 + i * 14},75%,58%,.75)`),
        borderRadius: 4, borderSkipped: false
      }]
    }, barOpts({ indexAxis: 'y', plugins: { legend: { display: false } } }));
  })();

  async function loadMonthly(state) {
    const m = await fetch(`/api/monthly?state=${encodeURIComponent(state)}`).then(r => r.json());
    mkChart('monthlyChart', 'line', {
      labels: m.months,
      datasets: [{ label: 'Avg Usage', data: m.usage, borderColor: C.a1, backgroundColor: 'rgba(0,229,255,.07)', tension: .4, fill: true, pointRadius: 4, pointBackgroundColor: C.a1 }]
    }, lineOpts());
  }

  async function loadDist(state) {
    const dist = await fetch(`/api/distribution?state=${encodeURIComponent(state)}`).then(r => r.json());
    mkChart('distChart', 'bar', {
      labels: dist.bins,
      datasets: [{ label: 'Count', data: dist.counts, backgroundColor: 'rgba(0,229,255,.3)', borderColor: C.a1, borderWidth: 1, borderRadius: 2 }]
    }, barOpts({
      plugins: { legend: { display: false } },
      scales: {
        x: { title: { display: true, text: 'Energy Usage (kWh)', color: C.muted }, grid: { display: false }, ticks: { color: C.muted } },
        y: { title: { display: true, text: 'Frequency', color: C.muted }, grid: { color: C.border }, ticks: { color: C.muted } }
      }
    }));
  }
</script>
{% endblock %}