{% extends "base.html" %}
{% set active = "predict" %}
{% block title %}Predict Â· EnergyIQ{% endblock %}
{% block content %}
<div class="page-header">
  <div class="page-title">Live <span class="accent">Prediction</span></div>
  <div class="page-subtitle">Select a state and date â€” weather & lag features are fetched automatically</div>
</div>

<div class="ridge-banner">
  <div class="rb-icon">ğŸ“¦</div>
  <div>
    <div class="rb-title">Using <code>ridge_model.pkl</code> â€” pre-trained Ridge Regression</div>
    <div class="rb-sub">Î± = 10 Â· 16 features Â· Test RÂ² = 0.9752 Â· Test MAE = 9.71</div>
  </div>
  <div class="rb-badge">Pre-trained</div>
</div>

<div class="chart-card">
  <div class="cc-head">
    <span class="cc-title">Prediction Inputs</span>
    <span class="cc-badge" id="fetchStatus">â€“</span>
  </div>

  <!-- User inputs -->
  <div class="predict-form-grid" style="margin-bottom:1.25rem">
    <div class="form-group">
      <label class="form-label">State</label>
      <select id="stateSelect">
        <option value="">â€” Select a state â€”</option>
      </select>
      <span class="form-hint">Latitude & longitude auto-filled</span>
    </div>
    <div class="form-group">
      <label class="form-label">Date</label>
      <input type="date" id="dateInput">
      <span class="form-hint">Day, month, quarter, day-of-week auto-derived</span>
    </div>
  </div>

  <!-- Auto-fetched fields display -->
  <div style="font-size:.68rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:.7rem">Auto-fetched Values</div>
  <div class="auto-fields" id="autoFields">
    <div class="auto-field-card"><div class="af-label">Latitude</div><div class="af-value loading" id="af_lat">â€“</div></div>
    <div class="auto-field-card"><div class="af-label">Longitude</div><div class="af-value loading" id="af_lon">â€“</div></div>
    <div class="auto-field-card"><div class="af-label">Temperature (Â°C)</div><div class="af-value loading" id="af_temp">â€“</div><div class="af-source" id="af_temp_src"></div></div>
    <div class="auto-field-card"><div class="af-label">Humidity (%)</div><div class="af-value loading" id="af_hum">â€“</div><div class="af-source" id="af_hum_src"></div></div>
    <div class="auto-field-card"><div class="af-label">Day of Week</div><div class="af-value loading" id="af_dow">â€“</div></div>
    <div class="auto-field-card"><div class="af-label">Is Weekend</div><div class="af-value loading" id="af_wknd">â€“</div></div>
    <div class="auto-field-card"><div class="af-label">Day</div><div class="af-value loading" id="af_day">â€“</div></div>
    <div class="auto-field-card"><div class="af-label">Month</div><div class="af-value loading" id="af_month">â€“</div></div>
    <div class="auto-field-card"><div class="af-label">Quarter</div><div class="af-value loading" id="af_qtr">â€“</div></div>
    <div class="auto-field-card"><div class="af-label">Lag 1</div><div class="af-value loading" id="af_lag1">â€“</div><div class="af-source">from dataset</div></div>
    <div class="auto-field-card"><div class="af-label">Lag 7</div><div class="af-value loading" id="af_lag7">â€“</div><div class="af-source">from dataset</div></div>
    <div class="auto-field-card"><div class="af-label">Lag 14</div><div class="af-value loading" id="af_lag14">â€“</div><div class="af-source">from dataset</div></div>
    <div class="auto-field-card"><div class="af-label">Rolling 7</div><div class="af-value loading" id="af_r7">â€“</div><div class="af-source">from dataset</div></div>
    <div class="auto-field-card"><div class="af-label">Rolling 14</div><div class="af-value loading" id="af_r14">â€“</div><div class="af-source">from dataset</div></div>
    <div class="auto-field-card"><div class="af-label">Rolling 30</div><div class="af-value loading" id="af_r30">â€“</div><div class="af-source">from dataset</div></div>
    <div class="auto-field-card"><div class="af-label">Rolling Std 7</div><div class="af-value loading" id="af_std7">â€“</div><div class="af-source">from dataset</div></div>
  </div>

  <div id="errorMsg" class="error-msg" style="display:none"></div>

  <button class="predict-btn" id="predictBtn" onclick="runPredict()" disabled>âš¡ Predict Usage</button>

  <div class="predict-result" id="predictResult">
    <div class="pr-label">Predicted Energy Usage</div>
    <div class="pr-value" id="predictValue">â€“</div>
    <div class="pr-meta" id="predictMeta">â€“</div>
    <div class="pr-inputs-summary" id="prSummary"></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const DAY_NAMES = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
let stateCoords = {};
let currentFeatures = null;

// â”€â”€ Init: load state list + coords â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  const [stateList, coords] = await Promise.all([
    fetch('/api/state_list').then(r=>r.json()),
    fetch('/api/state_coords').then(r=>r.json()),
  ]);
  stateCoords = coords;
  const sel = document.getElementById('stateSelect');
  stateList.forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);

  // Default date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('dateInput').value = today;

  sel.addEventListener('change', onInputChange);
  document.getElementById('dateInput').addEventListener('change', onInputChange);
})();

// â”€â”€ Derive date fields from a date string â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function deriveDateFields(dateStr) {
  const d = new Date(dateStr + 'T00:00:00');
  const dow = (d.getDay() + 6) % 7; // 0=Mon â€¦ 6=Sun (Python convention)
  const isWknd = (dow >= 5) ? 1 : 0;
  return {
    Day:       d.getDate(),
    Month:     d.getMonth() + 1,
    Quarter:   Math.ceil((d.getMonth() + 1) / 3),
    DayOfWeek: dow,
    IsWeekend: isWknd,
  };
}

// â”€â”€ On state or date change â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function onInputChange() {
  const state   = document.getElementById('stateSelect').value;
  const dateStr = document.getElementById('dateInput').value;
  if (!state || !dateStr) return;

  setStatus('Fetching dataâ€¦', true);
  document.getElementById('predictBtn').disabled = true;
  document.getElementById('errorMsg').style.display = 'none';
  currentFeatures = null;

  const coords = stateCoords[state];
  if (!coords) { showError(`Coordinates not found for "${state}"`); return; }

  // Fill lat/lon immediately
  setAF('af_lat',  coords.lat, '');
  setAF('af_lon',  coords.lon, '');

  // Derive date fields immediately
  const dateFields = deriveDateFields(dateStr);
  setAF('af_dow',   `${dateFields.DayOfWeek} (${DAY_NAMES[dateFields.DayOfWeek]})`, '');
  setAF('af_wknd',  dateFields.IsWeekend === 1 ? '1 (Weekend)' : '0 (Weekday)', '');
  setAF('af_day',   dateFields.Day, '');
  setAF('af_month', `${dateFields.Month} (${MONTH_NAMES[dateFields.Month-1]})`, '');
  setAF('af_qtr',   `Q${dateFields.Quarter}`, '');

  // Fetch weather & lag features in parallel
  const weatherUrl = `/api/weather?lat=${coords.lat}&lon=${coords.lon}&date=${dateStr}`;
  const lagUrl     = `/api/lag_features?state=${encodeURIComponent(state)}&date=${dateStr}`;

  try {
    const [weather, lags] = await Promise.all([
      fetch(weatherUrl).then(r=>r.json()),
      fetch(lagUrl).then(r=>r.json()),
    ]);

    if (weather.error) throw new Error('Weather: ' + weather.error);
    if (lags.error)    throw new Error('Lag features: ' + lags.error);

    setAF('af_temp', weather.temperature ?? 'N/A', weather.source || 'open-meteo.com');
    setAF('af_hum',  weather.humidity    ?? 'N/A', weather.source || 'open-meteo.com');
    setAF('af_lag1',  lags.Lag1,  '');
    setAF('af_lag7',  lags.Lag7,  '');
    setAF('af_lag14', lags.Lag14, '');
    setAF('af_r7',    lags.Rolling7,    '');
    setAF('af_r14',   lags.Rolling14,   '');
    setAF('af_r30',   lags.Rolling30,   '');
    setAF('af_std7',  lags.RollingStd7, '');

    // Bundle all features
    currentFeatures = {
      latitude:    coords.lat,
      longitude:   coords.lon,
      temperature: weather.temperature ?? 0,
      humidity:    weather.humidity    ?? 0,
      DayOfWeek:   dateFields.DayOfWeek,
      IsWeekend:   dateFields.IsWeekend,
      Day:         dateFields.Day,
      Month:       dateFields.Month,
      Quarter:     dateFields.Quarter,
      Lag1:        lags.Lag1,
      Lag7:        lags.Lag7,
      Lag14:       lags.Lag14,
      Rolling7:    lags.Rolling7,
      Rolling14:   lags.Rolling14,
      Rolling30:   lags.Rolling30,
      RollingStd7: lags.RollingStd7,
    };

    setStatus('Ready to predict', false);
    document.getElementById('predictBtn').disabled = false;

  } catch(e) {
    showError(e.message);
    setStatus('Error', false);
  }
}

// â”€â”€ Run prediction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runPredict() {
  if (!currentFeatures) return;
  const btn = document.getElementById('predictBtn');
  btn.textContent = 'â³ Predictingâ€¦'; btn.disabled = true;

  try {
    const res = await fetch('/api/predict', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(currentFeatures)
    }).then(r=>r.json());

    if (res.error) throw new Error(res.error);

    const state   = document.getElementById('stateSelect').value;
    const dateStr = document.getElementById('dateInput').value;
    document.getElementById('predictValue').textContent = res.prediction + ' kWh';
    document.getElementById('predictMeta').textContent  = res.model;
    document.getElementById('prSummary').innerHTML = `
      <span class="pr-chip">ğŸ“ ${state}</span>
      <span class="pr-chip">ğŸ“… ${dateStr}</span>
      <span class="pr-chip">ğŸŒ¡ ${currentFeatures.temperature}Â°C</span>
      <span class="pr-chip">ğŸ’§ ${currentFeatures.humidity}%</span>
      <span class="pr-chip">Lag1: ${currentFeatures.Lag1}</span>
      <span class="pr-chip">Roll7: ${currentFeatures.Rolling7}</span>
    `;
    document.getElementById('predictResult').classList.add('visible');
  } catch(e) {
    showError(e.message);
  }
  btn.textContent = 'âš¡ Predict Usage'; btn.disabled = false;
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setAF(id, val, src) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = val;
  el.classList.remove('loading');
  const srcEl = document.getElementById(id + '_src');
  if (srcEl && src) srcEl.textContent = src;
}

function setStatus(msg, loading) {
  const badge = document.getElementById('fetchStatus');
  badge.textContent = loading ? 'â³ ' + msg : msg;
}

function showError(msg) {
  const el = document.getElementById('errorMsg');
  el.textContent = 'âš  ' + msg;
  el.style.display = 'block';
}
</script>
{% endblock %}