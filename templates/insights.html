{% extends "base.html" %}
{% set active = "insights" %}
{% block title %}Insights Â· EnergyIQ{% endblock %}
{% block content %}
<div class="page-header">
  <div class="page-title">Data <span class="accent">Insights</span></div>
  <div class="page-subtitle">Patterns, correlations and seasonal behaviour</div>
</div>

<div class="grid-2" id="insightCards" style="margin-bottom:1.5rem"></div>

<div class="chart-card">
  <div class="cc-head"><span class="cc-title">Feature Correlation with Usage</span><span class="cc-badge">Simple Bar
      Chart</span></div>
  <div class="chart-wrap" style="height:420px"><canvas id="corrChart"></canvas></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (async () => {
    const [ov, ww, m, corr] = await Promise.all([
      fetch('/api/overview').then(r => r.json()),
      fetch('/api/weekday_weekend').then(r => r.json()),
      fetch('/api/monthly').then(r => r.json()),
      fetch('/api/correlation').then(r => r.json()),
    ]);

    const wkDiff = (((ww.values[1] - ww.values[0]) / ww.values[0]) * 100).toFixed(1);
    const maxMon = m.months[m.usage.indexOf(Math.max(...m.usage))];
    const minMon = m.months[m.usage.indexOf(Math.min(...m.usage))];

    document.getElementById('insightCards').innerHTML = `
    <div class="insight-card">
      <div class="insight-icon">ğŸ“…</div>
      <div class="insight-title">Peak Season</div>
      <div class="insight-stat" style="color:var(--a1)">${maxMon}</div>
      <div class="insight-text">Consumption peaks in <strong>${maxMon}</strong> and dips in <strong>${minMon}</strong>. The seasonal swing reflects heating/cooling demand driven by temperature extremes across states.</div>
    </div>
    <div class="insight-card">
      <div class="insight-icon">ğŸ </div>
      <div class="insight-title">Weekend Effect</div>
      <div class="insight-stat" style="color:var(--a2)">${wkDiff > 0 ? '+' : ''}${wkDiff}%</div>
      <div class="insight-text">Weekend consumption is <strong>${Math.abs(wkDiff)}% ${wkDiff > 0 ? 'higher' : 'lower'}</strong> than weekdays â€” suggesting ${wkDiff > 0 ? 'residential loads dominate' : 'commercial demand drives weekday peaks'}.</div>
    </div>
    <div class="insight-card">
      <div class="insight-icon">ğŸ”—</div>
      <div class="insight-title">Lag Feature Dominance</div>
      <div class="insight-stat" style="color:var(--a4)">Lag1 â†’ 30.7%</div>
      <div class="insight-text">Previous day's usage (<strong>Lag1</strong>) is the single strongest predictor at 30.7% RF importance, confirming high autocorrelation. Rolling averages collectively account for ~43%.</div>
    </div>
    <div class="insight-card">
      <div class="insight-icon">ğŸŒ</div>
      <div class="insight-title">Geographic Coverage</div>
      <div class="insight-stat" style="color:var(--a3)">${ov.num_states} States</div>
      <div class="insight-text">Dataset spans <strong>${ov.date_range}</strong> across ${ov.num_states} Indian states, capturing diverse climatic, economic and behavioural consumption patterns.</div>
    </div>
  `;

    // Simple Bar Chart of Feature Correlation with Usage
    const usageIdx = corr.labels.indexOf('Usage');
    if (usageIdx !== -1) {
      const usageCorr = corr.labels.map((lbl, i) => ({ label: lbl, val: corr.matrix[i][usageIdx] }))
        .filter(x => x.label !== 'Usage')
        .sort((a, b) => Math.abs(b.val) - Math.abs(a.val));

      mkChart('corrChart', 'bar', {
        labels: usageCorr.map(x => x.label),
        datasets: [{
          label: 'Correlation with Usage',
          data: usageCorr.map(x => x.val),
          backgroundColor: usageCorr.map(x => x.val >= 0 ? 'rgba(0,229,255,0.7)' : 'rgba(255,107,53,0.7)'),
          borderRadius: 4
        }]
      }, barOpts({ indexAxis: 'y', plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `Correlation: ${c.raw}` } } } }));
    }
  })();
</script>
{% endblock %}