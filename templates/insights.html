{% extends "base.html" %}
{% set active = "insights" %}
{% block title %}Insights Â· EnergyIQ{% endblock %}
{% block content %}
<div class="page-header">
  <div class="page-title">Data <span class="accent">Insights</span></div>
  <div class="page-subtitle">Patterns, correlations and seasonal behaviour</div>
</div>

<div class="grid-2" id="insightCards" style="margin-bottom:1.5rem"></div>

<div class="chart-card">
  <div class="cc-head"><span class="cc-title">Correlation Heatmap</span><span class="cc-badge">Numeric features</span></div>
  <div class="chart-wrap" style="height:420px"><canvas id="corrChart"></canvas></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(async () => {
  const [ov, ww, m, corr] = await Promise.all([
    fetch('/api/overview').then(r=>r.json()),
    fetch('/api/weekday_weekend').then(r=>r.json()),
    fetch('/api/monthly').then(r=>r.json()),
    fetch('/api/correlation').then(r=>r.json()),
  ]);

  const wkDiff = (((ww.values[1]-ww.values[0])/ww.values[0])*100).toFixed(1);
  const maxMon = m.months[m.usage.indexOf(Math.max(...m.usage))];
  const minMon = m.months[m.usage.indexOf(Math.min(...m.usage))];

  document.getElementById('insightCards').innerHTML = `
    <div class="insight-card">
      <div class="insight-icon">ğŸ“…</div>
      <div class="insight-title">Peak Season</div>
      <div class="insight-stat" style="color:var(--a1)">${maxMon}</div>
      <div class="insight-text">Consumption peaks in <strong>${maxMon}</strong> and dips in <strong>${minMon}</strong>. The seasonal swing reflects heating/cooling demand driven by temperature extremes across states.</div>
    </div>
    <div class="insight-card">
      <div class="insight-icon">ğŸ </div>
      <div class="insight-title">Weekend Effect</div>
      <div class="insight-stat" style="color:var(--a2)">${wkDiff>0?'+':''}${wkDiff}%</div>
      <div class="insight-text">Weekend consumption is <strong>${Math.abs(wkDiff)}% ${wkDiff>0?'higher':'lower'}</strong> than weekdays â€” suggesting ${wkDiff>0?'residential loads dominate':'commercial demand drives weekday peaks'}.</div>
    </div>
    <div class="insight-card">
      <div class="insight-icon">ğŸ”—</div>
      <div class="insight-title">Lag Feature Dominance</div>
      <div class="insight-stat" style="color:var(--a4)">Lag1 â†’ 30.7%</div>
      <div class="insight-text">Previous day's usage (<strong>Lag1</strong>) is the single strongest predictor at 30.7% RF importance, confirming high autocorrelation. Rolling averages collectively account for ~43%.</div>
    </div>
    <div class="insight-card">
      <div class="insight-icon">ğŸŒ</div>
      <div class="insight-title">Geographic Coverage</div>
      <div class="insight-stat" style="color:var(--a3)">${ov.num_states} States</div>
      <div class="insight-text">Dataset spans <strong>${ov.date_range}</strong> across ${ov.num_states} Indian states, capturing diverse climatic, economic and behavioural consumption patterns.</div>
    </div>
  `;

  // Correlation heatmap
  const n = corr.labels.length;
  const pts = [];
  for (let i=0;i<n;i++) for (let j=0;j<n;j++) pts.push({x:j,y:i,v:corr.matrix[i][j]});
  if (charts['corrChart']) charts['corrChart'].destroy();
  charts['corrChart'] = new Chart(document.getElementById('corrChart'), {
    type:'scatter',
    data:{ datasets:[{
      data:pts, pointStyle:'rect',
      pointRadius: ctx => (ctx.chart.width/n)*0.46,
      backgroundColor: ctx => {
        const v=ctx.raw.v;
        return v>=0 ? `rgba(0,229,255,${Math.abs(v)*.85})` : `rgba(255,107,53,${Math.abs(v)*.85})`;
      },
      borderColor:'transparent'
    }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{legend:{display:false}, tooltip:{ callbacks:{ label:c=>`${corr.labels[c.raw.y]} â†” ${corr.labels[c.raw.x]}: ${c.raw.v}` }}},
      scales:{
        x:{ type:'linear',min:-0.5,max:n-0.5, ticks:{stepSize:1,color:C.muted,callback:v=>corr.labels[v]||''}, grid:{display:false}},
        y:{ type:'linear',min:-0.5,max:n-0.5,reverse:true, ticks:{stepSize:1,color:C.muted,callback:v=>corr.labels[v]||''}, grid:{display:false}}
      }
    }
  });
})();
</script>
{% endblock %}