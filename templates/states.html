{% extends "base.html" %}
{% set active = "states" %}
{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
{% endblock %}

{% block content %}
<div class="page-header">
  <div class="page-title">Interactive <span class="accent">Usage Map</span></div>
  <div class="page-subtitle">Geographical distribution of energy consumption</div>
</div>

<div class="chart-card">
  <div class="cc-head"><span class="cc-title">Average Usage by State</span><span
      class="cc-badge">Choropleth/Bubble</span></div>
  <div class="chart-wrap" style="height:420px; border-radius:12px; overflow:hidden;">
    <div id="indiaMap" style="width:100%; height:100%; z-index:1;"></div>
  </div>
</div>

<div class="chart-card">
  <div class="cc-head"><span class="cc-title">State Statistics</span></div>
  <input type="text" id="stateSearch" placeholder="Search stateâ€¦" style="max-width:280px;margin-bottom:1rem">
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>State</th>
          <th>Avg Usage</th>
          <th>Total Usage</th>
          <th>Max</th>
          <th>Min</th>
        </tr>
      </thead>
      <tbody id="stateTableBody"></tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
  let allRows = [];
  (async () => {
    allRows = (await fetch('/api/states').then(r => r.json())).sort((a, b) => b.avg - a.avg);

    // Initialize Leaflet Map
    const map = L.map('indiaMap').setView([22.5, 79.0], 4);

    // Use a dark-themed CartoDB map tile layer that matches our UI
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 10,
      minZoom: 3
    }).addTo(map);

    // Calculate scales for bubbles
    const maxAvg = Math.max(...allRows.map(s => s.avg));
    const minAvg = Math.min(...allRows.map(s => s.avg));

    // Store markers to resize them later based on zoom level
    const markers = [];

    allRows.forEach(s => {
      if (s.lat && s.lon) {
        // Calculate relative size (0.0 to 1.0)
        const relSize = (s.avg - minAvg) / (maxAvg - minAvg || 1);

        // Color from cyan (low) to red/orange (high)
        const color = relSize > 0.6 ? '#ff6b35' : (relSize > 0.3 ? '#7b61ff' : '#00e5ff');

        const circle = L.circleMarker([s.lat, s.lon], {
          fillColor: color,
          color: color,
          weight: 1,
          opacity: 0.8,
          fillOpacity: 0.5
        }).addTo(map);

        // Attach relative size so we can dynamically scale it
        circle.relSize = relSize;
        markers.push(circle);

        // Interaction: Highlight on hover
        circle.on('mouseover', function () {
          this.setStyle({ weight: 3, fillOpacity: 0.9, color: '#fff' });
          this.bringToFront();
        });
        circle.on('mouseout', function () {
          this.setStyle({ weight: 1, fillOpacity: 0.5, color: color });
        });

        // Interaction: Click to filter table
        circle.on('click', function () {
          const searchInput = document.getElementById('stateSearch');
          searchInput.value = s.state;
          searchInput.dispatchEvent(new Event('input'));
          searchInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });

        // Tooltip binding
        circle.bindTooltip(`
        <div style="font-family:'Syne',sans-serif; text-transform:uppercase; font-size:0.7rem; font-weight:700; color:#6b7fa3; margin-bottom:0.2rem;">${s.state}</div>
        <div style="font-family:'DM Mono',monospace; font-size:1.1rem; color:#00e5ff; font-weight:800;">${s.avg} <span style="font-size:0.7rem; color:#6b7fa3;">kWh</span></div>
      `, {
          className: 'custom-map-tooltip',
          direction: 'top'
        });
      }
    });

    // Helper to resize markers based on current zoom
    function updateMarkerSizes() {
      const zoom = map.getZoom();
      // Base radius decreases at lower zoom levels, increases at higher zoom levels
      const zoomFactor = Math.pow(1.3, zoom - 4); // 4 is the starting zoom

      markers.forEach(c => {
        // dynamic radius = minRadius + (spread * relSize) * zoomFactor
        // At zoom 4, max radius is ~30 and min is ~5
        // At zoom 3, max radius is ~23 and min is ~3
        const minRadius = Math.max(2, 5 * zoomFactor);
        const maxRadius = Math.max(4, 30 * zoomFactor);
        const newR = minRadius + ((maxRadius - minRadius) * c.relSize);
        c.setRadius(newR);
      });
    }

    // Initialize sizes and listen to zoom events
    updateMarkerSizes();
    map.on('zoomend', updateMarkerSizes);

    renderTable(allRows);
    document.getElementById('stateSearch').addEventListener('input', e => {
      const q = e.target.value.toLowerCase();
      renderTable(allRows.filter(s => s.state.toLowerCase().includes(q)));
    });
  })();

  function renderTable(rows) {
    document.getElementById('stateTableBody').innerHTML = rows.map((s, i) => `
    <tr>
      <td style="color:var(--muted)">${i + 1}</td>
      <td><strong>${s.state}</strong></td>
      <td style="color:var(--a1)">${s.avg}</td>
      <td>${(s.total / 1e3).toFixed(1)}K</td>
      <td style="color:var(--a2)">${s.max}</td>
      <td style="color:var(--a4)">${s.min}</td>
    </tr>`).join('');
  }
</script>
<style>
  /* Custom Leaflet Tooltip purely for fitting our dark theme */
  .leaflet-tooltip.custom-map-tooltip {
    background: #0d1320;
    border: 1px solid #1e2d45;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    padding: 0.6rem 0.8rem;
  }

  .leaflet-tooltip-top.custom-map-tooltip::before {
    border-top-color: #1e2d45;
  }
</style>
{% endblock %}