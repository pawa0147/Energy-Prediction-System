{% extends "base.html" %}
{% set active = "models" %}
{% block title %}Models · EnergyIQ{% endblock %}
{% block content %}
<div class="page-header">
  <div class="page-title">Model <span class="accent">Comparison</span></div>
  <div class="page-subtitle">Ridge · Lasso · Random Forest — metrics from energy2.ipynb</div>
</div>

<div class="model-cards" id="modelCards"></div>

<div class="grid-2">
  <div class="chart-card" style="margin-bottom:0">
    <div class="cc-head"><span class="cc-title">Model Scores (Train vs Test R²)</span><span class="cc-badge">Higher =
        better</span></div>
    <div class="chart-wrap" style="height:250px"><canvas id="r2Chart"></canvas></div>
  </div>
  <div class="chart-card" style="margin-bottom:0">
    <div class="cc-head"><span class="cc-title">Mean Absolute Errors (Train vs Test)</span><span class="cc-badge">Lower
        = better</span></div>
    <div class="chart-wrap" style="height:250px"><canvas id="maeChart"></canvas></div>
  </div>
</div>
<div class="grid-2" style="margin-top:1.5rem">
  <div class="chart-card" style="margin-bottom:0">
    <div class="cc-head"><span class="cc-title">Root Mean Square Errors (Train vs Test)</span><span
        class="cc-badge">Lower = better</span></div>
    <div class="chart-wrap" style="height:250px"><canvas id="rmseChart"></canvas></div>
  </div>
  <div class="chart-card" style="margin-bottom:0">
    <div class="cc-head"><span class="cc-title">Mean Squared Test Errors</span><span class="cc-badge">Lower =
        better</span></div>
    <div class="chart-wrap" style="height:250px"><canvas id="mseChart"></canvas></div>
  </div>
</div>

<div class="chart-card" style="margin-top:1.5rem">
  <div class="cc-head"><span class="cc-title">Performance Radar (Test Set · normalised)</span><span class="cc-badge">All
      5 metrics</span></div>
  <div class="chart-wrap" style="height:340px"><canvas id="radarChart"></canvas></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (async () => {
    const data = await fetch('/api/models').then(r => r.json());
    const colors = [C.a1, C.a3, C.a2];
    const cls = ['ridge', 'lasso', 'rf'];

    document.getElementById('modelCards').innerHTML = data.map((m, i) => `
    <div class="model-card ${cls[i]}">
      <div class="mc-name" style="color:${colors[i]}">${m.name}</div>
      <div class="mc-alpha">${m.alpha}</div>
      <div class="mc-rows">
        <div class="mc-row"><span class="mc-row-label">R²</span><div class="mc-row-vals"><span class="mc-train">${m.train_r2}</span><span class="mc-test" style="color:${colors[i]}">${m.test_r2}</span></div></div>
        <div class="mc-sep"></div>
        <div class="mc-row"><span class="mc-row-label">MAE</span><div class="mc-row-vals"><span class="mc-train">${m.train_mae}</span><span class="mc-test" style="color:${colors[i]}">${m.test_mae}</span></div></div>
        <div class="mc-row"><span class="mc-row-label">MSE</span><div class="mc-row-vals"><span class="mc-train">${m.train_mse}</span><span class="mc-test" style="color:${colors[i]}">${m.test_mse}</span></div></div>
        <div class="mc-row"><span class="mc-row-label">RMSE</span><div class="mc-row-vals"><span class="mc-train">${m.train_rmse}</span><span class="mc-test" style="color:${colors[i]}">${m.test_rmse}</span></div></div>
        <div class="mc-row"><span class="mc-row-label">MAPE</span><div class="mc-row-vals"><span class="mc-train" style="font-size:.7rem">test only</span><span class="mc-test" style="color:${colors[i]}">${m.mape}%</span></div></div>
      </div>
      ${m.zeroed && m.zeroed.length ? `
        <div style="font-size:.62rem;color:var(--muted);margin-top:.9rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;">Zeroed by Lasso</div>
        <div class="zeroed-list">${m.zeroed.map(z => `<span class="zeroed-tag">${z}</span>`).join('')}</div>
      `: ''}
      <div class="mc-note">${m.note}</div>
    </div>
  `).join('');

    const names = data.map(m => m.name);
    const twoDS = (trainKey, testKey, c1, c2) => ([
      { label: 'Train', data: data.map(m => m[trainKey]), backgroundColor: c1, borderRadius: 6, borderSkipped: false },
      { label: 'Test', data: data.map(m => m[testKey]), backgroundColor: c2, borderRadius: 6, borderSkipped: false },
    ]);

    mkChart('r2Chart', 'bar', { labels: names, datasets: twoDS('train_r2', 'test_r2', 'rgba(123,97,255,.55)', 'rgba(0,229,255,.8)') },
      barOpts({ scales: { x: { grid: { display: false }, ticks: { color: C.muted } }, y: { min: .92, max: 1, grid: { color: C.border }, ticks: { color: C.muted } } } }));

    mkChart('maeChart', 'bar', { labels: names, datasets: twoDS('train_mae', 'test_mae', 'rgba(255,107,53,.45)', 'rgba(255,107,53,.85)') }, barOpts());
    mkChart('rmseChart', 'bar', { labels: names, datasets: twoDS('train_rmse', 'test_rmse', 'rgba(0,255,157,.4)', 'rgba(0,255,157,.85)') }, barOpts());
    mkChart('mseChart', 'bar', { labels: names, datasets: twoDS('train_mse', 'test_mse', 'rgba(123,97,255,.4)', 'rgba(123,97,255,.85)') }, barOpts());

    const maxMAE = Math.max(...data.map(m => m.test_mae));
    const maxRMSE = Math.max(...data.map(m => m.test_rmse));
    const maxMSE = Math.max(...data.map(m => m.test_mse));
    const maxMAPE = Math.max(...data.map(m => m.mape));
    mkChart('radarChart', 'radar', {
      labels: ['Test R²', 'Low MAE', 'Low RMSE', 'Low MSE', 'Low MAPE'],
      datasets: data.map((m, i) => ({
        label: m.name,
        data: [m.test_r2, 1 - m.test_mae / maxMAE, 1 - m.test_rmse / maxRMSE, 1 - m.test_mse / maxMSE, 1 - m.mape / maxMAPE].map(v => +(v * 100).toFixed(1)),
        borderColor: colors[i], backgroundColor: colors[i] + '18',
        pointBackgroundColor: colors[i], borderWidth: 2,
      }))
    }, {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { color: C.muted, boxWidth: 12 } } },
      scales: { r: { grid: { color: C.border }, angleLines: { color: C.border }, ticks: { color: C.muted, backdropColor: 'transparent', stepSize: 20 }, pointLabels: { color: C.muted, font: { size: 11 } }, min: 0, max: 100 } }
    });
  })();
</script>
{% endblock %}